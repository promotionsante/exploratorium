---
title: "flat_filter_project_data.Rmd empty"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r development, include=FALSE}
library(testthat)
library(dplyr)
```

```{r development-load}
# Load already included functions if relevant
pkgload::load_all(export_all = FALSE)
```

# Load projects data

```{r function-load_projects_data}
#' Load projects data from disk
#' 
#' @param language A characer. Either "fr" or "de"
#' 
#' @return A sf data.frame
#' 
#' @noRd
load_projects_data <- function(language) {
  stopifnot(
    "Unknown language provided" = language %in% c("fr", "de")
  )
  readRDS(
    file = app_sys(
      "data-projects",
      sprintf("projects_%s.rds", language)
    )
  )
}
```

```{r example-load_projects_data}
load_projects_data(
  language = "fr"
)
```

```{r tests-load_projects_data}
test_that("load_projects_data() returns sf objects", {
  projects_de <- load_projects_data(
    language = "de"
  )
  projects_fr <- load_projects_data(
    language = "fr"
  )
  expect_s3_class(projects_de, "sf")
  expect_s3_class(projects_fr, "sf")
})

test_that("load_projects_data() returns an error if unknow language provided", {
  expect_error(
    load_projects_data(
      language = "es"
    ),
    regexp = "Unknown language provided"
  )
})
```

# Filter projects data

```{r function-filter_projects_data}
#' Filter projects data
#' 
#' Main function that powers the filtering of  mod_projects_selection_*()
#' 
#' @param projects_data_sf A sf data.frame. 
#' @param vec_topics A character vector of topics 
#' @param range_budget A numeric vector of size two defining the lower and 
#' upper bound of budget.
#' @param range_self_funded_budget A numeric vector of size two defining the lower and
#'  upper bound of self-funded budget.
#' @param canton_main_resp_orga A character vector containing the names of the 
#' cantons of interest.
#'
#' @return A sf data.frame
#' 
#' @noRd
filter_projects_data <- function(
    projects_data_sf,
    vec_topics,
    range_budget,
    range_self_funded_budget,
    canton_main_resp_orga
){
  #   projects_data_sf |> 
  #     separate_rows(
  #       geo_range_id, 
  #       sep = ", "
  #     ) |> 
  #   filter(
  #     topic %in% vec_topics,
  #     total_budget |> between(
  #       min(range_budget), 
  #       max(range_budget)
  #     ),
  #     budget_orga |> 
  #       between(
  #         min(range_self_funded_budget), 
  #         max(range_self_funded_budget)
  #       ),
  #    geo_range_id %in% canton_main_resp_orga
  #   )
  return(projects_data_sf)
}
```


```{r example-filter_projects_data}

```


```{r tests-filter_projects_data}
test_that("filter_projects_data() returns sf objects", {
  projects_de <- load_projects_data(
    language = "de"
  )
  projects_fr <- load_projects_data(
    language = "fr"
  )
  expect_s3_class(filter_projects_data(projects_de), "sf")
  expect_s3_class(filter_projects_data(projects_fr), "sf")
})
```


# Get unique topics to display

```{r function-get_topics_to_display}
#' Get unique topics to display 
#'
#' and put "other" topics at the end.
#' 
#' @param projects_data_sf A sf data.frame holding the column `topic`.
#'
#' @return A character vector ending with "Other" (andere/autre) topics
#' 
#' @noRd
get_topics_to_display <- function(projects_data_sf) {
  
  topics <- projects_data_sf |>
    getElement("topic") |>
    strsplit(", ") |>
    unlist() |>
    unique()
  
  # Isolate other topics in both FR and DE
  id_other_topics <- grep("Andere|Autre", topics)
  main_topics <- topics[-id_other_topics]
  other_topics <- topics[id_other_topics]
  
  topics_to_diplay <- c(
    sort(
      main_topics
    ),
    # Other topics should appear last
    other_topics
  )
  return(topics_to_diplay)
}
```

```{r example-get_topics_to_display}
projects_data_sf <- load_projects_data(
  language = "fr"
)
get_topics_to_display(
  projects_data_sf = projects_data_sf
)
```

```{r tests-get_topics_to_display}
test_that("get_topics_to_display() works in FR", {
  projects_data_sf <- load_projects_data(
    language = "fr"
  )
  topics_to_display <- get_topics_to_display(
    projects_data_sf = projects_data_sf
  )
  
  expect_type(
    topics_to_display,
    "character"
  )
  
  # Other topics are featured at the very end of the vector
  id_other_topics <- grep("Andere|Autre", topics_to_display)
  expect_setequal(
    id_other_topics,
    seq(
      from = length(topics_to_display), 
      length.out = length(id_other_topics), 
      by = -1
    )
  )
})

test_that("get_topics_to_display() works in DE", {
  projects_data_sf <- load_projects_data(
    language = "de"
  )
  topics_to_display <- get_topics_to_display(
    projects_data_sf = projects_data_sf
  )
  
  expect_type(
    topics_to_display,
    "character"
  )
  
  # Other topics are featured at the very end of the vector
  id_other_topics <- grep("Andere|Autre", topics_to_display)
  expect_setequal(
    id_other_topics,
    seq(
      from = length(topics_to_display), 
      length.out = length(id_other_topics), 
      by = -1
    )
  )
})

```



```{r development-inflate, eval=FALSE}
# Run but keep eval=FALSE to avoid infinite loop
# Execute in the console directly
fusen::inflate(
  flat_file = "dev/flat_filter_project_data.Rmd", 
  vignette_name = NA,
  overwrite = TRUE,
  check = FALSE
)
```

