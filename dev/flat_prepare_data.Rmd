---
title: "Prepare data"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  eval=FALSE,
  echo=TRUE
)
```

```{r development, include=FALSE}
```

```{r development-load}
# Load already included functions if relevant
pkgload::load_all(export_all = FALSE)
```

*The aim of this article is to show you how to update the data used by the app.*

The app uses 2 types of data: 

- Projects data saved in a .rds format with all the data
- Projects cards in a .html format

```{r echo=FALSE, eval=TRUE, fig.align='center', out.width='40%'}
knitr::include_graphics("../man/figures/type_data.png")
```

The data preparation workflow is shown below. **This data preparation process must be repeated each time the raw data is modified or each time a modification is required to the data dictionaries.**

```{r echo=FALSE, eval=TRUE, fig.align='center', out.width='100%'}
knitr::include_graphics("../man/figures/data_prep_workflow.png")
```

# Modify the raw data about the projects or modify the translations

## Modify the raw data about the projects

You must upload the new version of the file `PGV.xlsx` in the `inst/data-projects-raw` folder.

```{r echo=FALSE, eval=TRUE, fig.align='center', out.width='20%'}
knitr::include_graphics("../man/figures/update_raw_projects_data.png")
```

## Modify the data concerning the translations

You must modify directly the dictionaries used for the translations. They are saved in the `inst/data-dic` folder, in a `.csv` format.

```{r echo=FALSE, eval=TRUE, fig.align='center', out.width='80%'}
knitr::include_graphics("../man/figures/update_dic_data.png")
```

### dic_variables.csv

The content of **"dic_variables.csv"** is the following one:

```{r echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
DT::datatable(
  readr::read_csv2(
    system.file(
      "data-dic",
      "dic_variables.csv", 
      package = "exploratorium"
    )
  )
)
```

### dic_cantons.csv

The content of **"dic_cantons.csv"** is the following one:

```{r echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
DT::datatable(
  readr::read_csv(
    system.file(
      "data-dic",
      "dic_cantons.csv", 
      package = "exploratorium"
    )
  )
)
```
  
### dic_values.csv

The content of **"dic_values.csv"** is the following one:

```{r echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
DT::datatable(
  readr::read_csv2(
    system.file(
      "data-dic",
      "dic_values.csv", 
      package = "exploratorium"
    )
  )
)
```

### dic_titles_app.csv and i18n_locales.json

The content of **"dic_titles_app.csv"** is the following one:

```{r echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
DT::datatable(
  readr::read_csv2(
    system.file(
      "data-dic",
      "dic_titles_app.csv", 
      package = "exploratorium"
    )
  )
)
```

The content of **"i18n_locales.json"** is the following one:

```{r echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}
json_content <- jsonlite::fromJSON(
  system.file(
    "app",
    "www",
    "i18n_locales.json",
    package = "exploratorium"
  )
)

translations_tibble <- tibble::tibble(
  id = names(unlist(json_content$de$translation)),
  de = unlist(json_content$de$translation),
  fr = unlist(json_content$fr$translation)
)

DT::datatable(
  translations_tibble
)
```

# Update the data used by the app

Then, to update the data used by the application, you can use the `prepare_app_data()` function as follows:

```{r function-prepare_app_data}
#' Prepare the app data
#' 
#' @param name_raw_file Character. Name of the raw data file.
#' @param pkg_dir Character. Path to the package (must contain a data-raw folder).
#' @param dic_variables Tibble. Variables dictionaries. Mainly used for examples and unit testing purpose.
#' @param dic_cantons Tibble. Canton dictionary. Mainly used for examples and unit testing purpose.
#' @param dic_titles_pages Tibble. Title of the pages dictionaries. Mainly used for examples and unit testing purpose.
#' @param cantons_sf Sf data. Cantons geometry. Mainly used for examples and unit testing purpose.
#' 
#' @importFrom glue glue
#' @importFrom here here
#' @importFrom cli cli_process_start cli_alert cli_process_done
#' 
#' @return Nothing to return, used for side effect. A message is displayed in the console.
#' 
#' @export
prepare_app_data <- function(
    name_raw_file = "PGV.xlsx",
    pkg_dir = system.file(package = "exploratorium"),
    dic_variables = NULL, 
    dic_cantons = NULL,
    dic_titles_pages = NULL,
    cantons_sf = NULL
  ){
  
  # Prepare the projects data
  projects_data <- prepare_projects_data(
    name_raw_file = name_raw_file,
    pkg_dir = pkg_dir,
    dic_variables = dic_variables,
    dic_cantons = dic_cantons,
    cantons_sf = cantons_sf
  )
  
  # Prepare the projects cards
  prepare_projects_cards(
    data_projects_fr = projects_data$data_fr,
    data_projects_de = projects_data$data_de,
    dic_titles_pages = dic_titles_pages,
    pkg_dir = pkg_dir
  )
  
  
}
```
  
```{r example-prepare_app_data, echo=FALSE}
# Load the toy datasets
data("toy_data_pgv")
data("toy_dic_variables")
data("toy_dic_cantons")
data("toy_dic_titles_pages")
data("toy_cantons_sf")

# Create a temp folder with data-projects-raw and ata-projects subfolder
my_temp_dir <- tempfile("test-prepare-data")
dir.create(my_temp_dir)
dir.create(file.path(my_temp_dir, "data-projects-raw"))
dir.create(file.path(my_temp_dir, "data-projects"))
dir.create(file.path(my_temp_dir, "data-projects-cards"))

# Save the toy PGV file inside
writexl::write_xlsx(
  toy_data_pgv, 
  file.path(
    my_temp_dir, 
    "data-projects-raw", 
    "toy_PGV.xlsx"
  )
)

# Prepare the data
prepare_app_data(
  name_raw_file = "toy_PGV.xlsx",
  pkg_dir = my_temp_dir, 
  dic_variables = toy_dic_variables, 
  dic_cantons = toy_dic_cantons,
  dic_titles_pages = toy_dic_titles_pages,
  cantons_sf = toy_cantons_sf
)

# Delete the tempdir
unlink(my_temp_dir, recursive = TRUE)
```

```{r}
prepare_app_data()
```

```{r tests-prepare_app_data}
test_that("Test that the preparation of the projects data is ok", {

  # Load the toy datasets
  data("toy_data_pgv")
  data("toy_dic_variables")
  data("toy_dic_cantons")
  data("toy_cantons_sf")
  data("toy_dic_titles_pages")
  
  # Create a temp folder with data-projects-raw and ata-projects subfolder
  my_temp_dir <- tempfile("test-prepare-data")
  dir.create(my_temp_dir)
  dir.create(file.path(my_temp_dir, "data-projects-raw"))
  dir.create(file.path(my_temp_dir, "data-projects"))
  dir.create(file.path(my_temp_dir, "data-projects-cards"))
  
  # Save the toy PGV file inside
  writexl::write_xlsx(toy_data_pgv,
                      file.path(my_temp_dir,
                                "data-projects-raw",
                                "toy_PGV.xlsx"))
  
  # Prepare the data
  prepare_app_data(
    name_raw_file = "toy_PGV.xlsx",
    pkg_dir = my_temp_dir, 
    dic_variables = toy_dic_variables, 
    dic_cantons = toy_dic_cantons,
    dic_titles_pages = toy_dic_titles_pages,
    cantons_sf = toy_cantons_sf
  )
  
  # Read the created data
  projects_data_fr <- readRDS(
    file.path(
      my_temp_dir,
      "data-projects",
      "projects_fr.rds"
    )
  )
  
  # Perform usage checks on the data
  
  #' @description Testing that the number of rows is the same than in the raw data
  expect_equal(
    object = nrow(projects_data_fr), 
    expected = nrow(toy_data_pgv) - 1 # remove the first line with FR variables names
  )
  
  #' @description Testing that the object contains geometry of points (SF)
  expect_true(
    inherits(projects_data_fr |>
               select(geometry), 
             "sf")
  )
  
  #' @description Testing that the object contains geometry of points with crs = 4326
  expect_equal(
    object = sf::st_crs(
      projects_data_fr |>
        select(geometry)
      )$input, 
    expected = "EPSG:4326"
  )
  
  #' @description Testing that the object contains a column geo_range_id
  expect_true(
    "geo_range_id" %in% colnames(projects_data_fr)
  )
  
  
  # Delete the tempdir
  unlink(my_temp_dir, recursive = TRUE)

})
```

```{r development-inflate, eval=FALSE}
# Run but keep eval=FALSE to avoid infinite loop
# Execute in the console directly
fusen::inflate(
  flat_file = "dev/flat_prepare_data.Rmd", 
  vignette_name = "Prepare/update data used by the app",
  check = FALSE, 
  overwrite = TRUE
)
```
