---
title: "Prepare data"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  eval=FALSE,
  echo=TRUE
)
```

```{r development, include=FALSE}
```

```{r development-load}
# Load already included functions if relevant
pkgload::load_all(export_all = FALSE)
```

*The aim of this article is to show you how to update the data used by the app.*

The data preparation workflow is shown below. **This data preparation process must be repeated each time the raw data is modified or each time a modification is required to the data dictionaries.**

```{r echo=FALSE, eval=TRUE, fig.align='center'}
knitr::include_graphics("../man/figures/data_prep_workflow.png")
```

# Modify the raw data about the projects or modify the translations

## Modify the raw data about the projects

You must upload the new version of the file `PGV.xlsx` in the `inst/data-projects-raw` folder.

```{r echo=FALSE, eval=TRUE, fig.align='center', out.width='20%'}
knitr::include_graphics("../man/figures/update_raw_projects_data.png")
```

## Modify the data concerning the translations

You must modify directly the dictionaries used for the translations. They are saved in the `inst/data-dic` folder, in a `.csv` format.

```{r echo=FALSE, eval=TRUE, fig.align='center', out.width='30%'}
knitr::include_graphics("../man/figures/update_dic_data.png")
```

The content of **"dic_variables.csv"** is the following one:

```{r echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
DT::datatable(
  readr::read_csv2(
    system.file(
      "data-dic",
      "dic_variables.csv", 
      package = "observatoire"
    )
  )
)
```

The content of **"dic_cantons.csv"** is the following one:

```{r echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
DT::datatable(
  readr::read_csv(
    system.file(
      "data-dic",
      "dic_cantons.csv", 
      package = "observatoire"
    )
  )
)
```
  
The content of **"dic_values.csv"** is the following one:

```{r echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
#TODO
```

# Update the data used by the app

Then, to update the data used by the application, you can use the `prepare_projects_data()` function as follows:

```{r function-prepare_projects_data}
#' Prepare the projects data in FR and DE to be included in the app as .rds files
#' 
#' @param name_raw_file Character. Name of the raw data file.
#' @param pkg_dir Character. Path to the package (must contain a data-raw folder).
#' @param dic_variables Tibble. Variables dictionaries. Mainly used for examples and unit testing purpose.
#' @param cantons_sf Sf data. Cantons geometry. Mainly used for examples and unit testing purpose.
#' 
#' @importFrom glue glue
#' @importFrom here here
#' @importFrom cli cli_process_start cli_alert cli_process_done
#' 
#' @return Nothing to return, used for side effect. A message is displayed in the console.
#' 
#' @export
prepare_projects_data <- function(
    name_raw_file = "PGV.xlsx",
    pkg_dir = system.file(package = "observatoire"),
    dic_variables = NULL, 
    cantons_sf = NULL
  ){
  
  cli_process_start(
    "Start to prepare projects_fr.rds and projects_de.rds"
  )

  # Prepare the data and save them
  cli_alert("Import the raw data")
  data_import <- import_raw_data(
    name_raw_file = name_raw_file,
    pkg_dir = pkg_dir
  )
  
  cli_alert("Add the columns")
  data_with_col <- data_import |>
    add_col_raw_data(
      dic_variables = 
        dic_variables
      ) 
  
  cli_alert("Clean the data")
  data_cleaned <- data_with_col |> 
    clean_raw_data()
  
  cli_alert("Add the coordinates of the main organization")
  data_with_coord <- data_cleaned |> 
    get_coord_main_resp_orga(
      cantons_sf = cantons_sf
    ) 
  
  cli_alert("Add the canton of the main organization")
  data_with_cantons <- data_with_coord |> 
    get_canton_main_resp_orga(
      cantons_sf = cantons_sf
    )
  
  cli_alert("Add the number of cantons influenced")
  data_with_nb_cantons <- data_with_cantons |> 
    get_nb_cantons_influenced() 
  
  cli_alert("Add the proportion of the budget")
  data_with_prop_budget <- data_with_nb_cantons |> 
    get_prop_budget()
  
  cli_alert("Translate the data")
  data_translated <- data_with_prop_budget |> 
    translate_values_in_data() 
  
  cli_alert("Save the data")
  save_projects_data(
    list_data_fr_de = data_translated,
    pkg_dir = pkg_dir
  )
  
  cli_process_done(
    "Finish to prepare projects_fr.rds and projects_de.rds"
  )
 
}
```
  
```{r example-prepare_projects_data, echo=FALSE}
# Load the toy datasets
data("toy_data_pgv")
data("toy_dic_variables")
data("toy_cantons_sf")

# Create a temp folder with data-projects-raw and ata-projects subfolder
my_temp_dir <- tempfile("test-prepare-data")
dir.create(my_temp_dir)
dir.create(file.path(my_temp_dir, "data-projects-raw"))
dir.create(file.path(my_temp_dir, "data-projects"))

# Save the toy PGV file inside
writexl::write_xlsx(
  toy_data_pgv, 
  file.path(
    my_temp_dir, 
    "data-projects-raw", 
    "toy_PGV.xlsx"
  )
)

# Prepare the data
prepare_projects_data(
  name_raw_file = "toy_PGV.xlsx",
  pkg_dir = my_temp_dir, 
  dic_variables = toy_dic_variables, 
  cantons_sf = toy_cantons_sf
)

# Delete the tempdir
unlink(my_temp_dir, recursive = TRUE)
```

```{r}
prepare_projects_data()
```

```{r tests-prepare_projects_data}
test_that("Test that the preparation of the projects data is ok", {

  # Load the toy datasets
  data("toy_data_pgv")
  data("toy_dic_variables")
  data("toy_cantons_sf")
  
  # Create a temp folder with data-projects-raw and ata-projects subfolder
  my_temp_dir <- tempfile("test-prepare-data")
  dir.create(my_temp_dir)
  dir.create(file.path(my_temp_dir, "data-projects-raw"))
  dir.create(file.path(my_temp_dir, "data-projects"))
  
  # Save the toy PGV file inside
  writexl::write_xlsx(toy_data_pgv,
                      file.path(my_temp_dir,
                                "data-projects-raw",
                                "toy_PGV.xlsx"))
  
  # Prepare the data
  prepare_projects_data(
    name_raw_file = "toy_PGV.xlsx",
    pkg_dir = my_temp_dir,
    dic_variables = toy_dic_variables,
    cantons_sf = toy_cantons_sf
  )
  
  # Read the created data
  projects_data_fr <- readRDS(
    file.path(
      my_temp_dir,
      "data-projects",
      "projects_fr.rds"
    )
  )
  
  # Perform usage checks on the data
  #' @description Testing that the object contains geometry of points (SF)
  expect_true(
    inherits(projects_data_fr |>
               select(geometry), 
             "sf")
  )
  
  #' @description Testing that the object contains geometry of points with crs = 4326
  expect_equal(
    object = sf::st_crs(
      projects_data_fr |>
        select(geometry)
      )$input, 
    expected = "EPSG:4326"
  )
  
  # Delete the tempdir
  unlink(my_temp_dir, recursive = TRUE)

})
```

```{r development-inflate, eval=FALSE}
# Run but keep eval=FALSE to avoid infinite loop
# Execute in the console directly
fusen::inflate(
  flat_file = "dev/flat_prepare_data.Rmd", 
  vignette_name = "Prepare/update data used by the app",
  check = FALSE, 
  overwrite = TRUE
)
```

