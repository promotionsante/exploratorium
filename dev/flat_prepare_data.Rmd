---
title: "Prepare data"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  eval=FALSE,
  echo=TRUE
)
```

```{r development, include=FALSE}
```

```{r development-load}
# Load already included functions if relevant
pkgload::load_all(export_all = FALSE)
```

*The aim of this article is to show you how to update the data used by the app.*

The data preparation workflow is shown below. **This data preparation process must be repeated each time the raw data is modified or each time a modification is required to the data dictionaries.**

```{r echo=FALSE, eval=TRUE, fig.align='center'}
knitr::include_graphics("../man/figures/data_prep_workflow.png")
```

# Modify the raw data about the projects or modify the translations

## Modify the raw data about the projects

You must upload the new version of the file `PGV.xlsx` in the `inst/data-projects-raw` folder.

```{r echo=FALSE, eval=TRUE, fig.align='center', out.width='20%'}
knitr::include_graphics("../man/figures/update_raw_projects_data.png")
```

## Modify the data concerning the translations

You must modify directly the dictionaries used for the translations. They are saved in the `inst/data-dic` folder, in a `.csv` format.

```{r echo=FALSE, eval=TRUE, fig.align='center', out.width='30%'}
knitr::include_graphics("../man/figures/update_dic_data.png")
```

The content of **"dic_variables.csv"** is the following one:

```{r echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
DT::datatable(
  readr::read_csv2(
    system.file(
      "data-dic",
      "dic_variables.csv", 
      package = "observatoire"
    )
  )
)
```

The content of **"dic_cantons.csv"** is the following one:

```{r echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
DT::datatable(
  readr::read_csv(
    system.file(
      "data-dic",
      "dic_cantons.csv", 
      package = "observatoire"
    )
  )
)
```
  
The content of **"dic_values.csv"** is the following one:

```{r echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
#TODO
```

# Update the data used by the app

Then, to update the data used by the application, you can use the `prepare_projects_data()` function as follows:

```{r function-prepare_projects_data}
#' Prepare the projects data in FR and DE to be included in the app as .rds files
#' 
#' @param name_raw_file Character. Name of the raw data file.
#' @param pkg_dir Character. Path to the package (must contain a data-raw folder).
#' 
#' @importFrom glue glue
#' @importFrom here here
#' 
#' @return Nothing to return, used for side effect. A message is displayed in the console.
#' 
#' @export
prepare_projects_data <- function(
    name_raw_file = "PGV.xlsx",
    pkg_dir = system.file(package = "observatoire")
  ){
  
  # Prepare the data and save them
  import_raw_data(
    name_raw_file = name_raw_file,
    pkg_dir = pkg_dir
  ) |> 
  add_col_raw_data() |> 
  clean_raw_data() |>
  get_coord_main_resp_orga() |>
  get_canton_main_resp_orga() |> 
  get_nb_cantons_influenced() |> 
  get_prop_budget() |> 
  translate_values_in_data() |> 
  save_projects_data(
    pkg_dir = pkg_dir
  )
 
}
```
  
```{r example-prepare_projects_data}
prepare_projects_data()
```

```{r tests-prepare_projects_data}
test_that("Test that the preparation of the projects data is ok", {

})
```

```{r development-inflate, eval=FALSE}
# Run but keep eval=FALSE to avoid infinite loop
# Execute in the console directly
fusen::inflate(
  flat_file = "dev/flat_prepare_data.Rmd", 
  vignette_name = "Prepare/update data used by the app",
  check = FALSE, 
  overwrite = TRUE
)
```

