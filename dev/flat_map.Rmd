---
title: "flat_map.Rmd empty"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r development, include=FALSE}
library(testthat)
library(sf)
library(leaflet)
```

```{r development-load}
# Load already included functions if relevant
pkgload::load_all(export_all = FALSE)
```



# Map utils

  
```{r function-map-utils}
#' Read cantons polygons data
#' @imoprtFrom sf st_read
#' @filename map_utils
#' @noRd
read_cantons_sf <- function() {
  st_read(
    dsn = system.file(
      "gadm41_CHE_1.json", 
      package = "observatoire"
    ),
    quiet = TRUE
  )
}

#' @filename map_utils
#' @noRd
compute_switzerland_centroid  <- function() {
  read_cantons_sf() |> 
    st_union() |> 
    st_centroid() |> 
    st_geometry() |> 
    unlist() |> 
    setNames(
      c("lng", "lat")
    )
}

#' @filename map_utils
#' @noRd
compute_switzerland_bounding_box <- function() {
  bounding_box <- read_cantons_sf() |> 
    st_bbox()
  attr(bounding_box, "crs") <- NULL
  attr(bounding_box, "class") <- NULL
  return(bounding_box)
}

#' @filename map_utils
#' @noRd
get_switzerland_centroid <- function() {
  # Generated via compute_switzerland_centroid() |> dput()
  c(
    lng = 8.22730129708567, 
    lat = 46.8019720665898
  )
}

#' @filename map_utils
#' @noRd
get_switzerland_bounding_box <- function() {
  # Generated via compute_switzerland_bounding_box() |> dput()
  c(
    xmin = 5.9561,
    ymin = 45.8171,
    xmax = 10.4948,
    ymax = 47.8085
  )
}

#' Generate dummy project data
#' @return A sf data.frame
#' @importFrom sf st_as_sf
#' @filename map_utils
#' @noRd
dummy_project_data_sf <- function() { 
  data.frame(
    short_title = "PSCH",
    addr = "52 Avenue de la Gare, 1003 Lausanne, Switzerland",
    lat = 46.51756965,
    long = 6.63061493418584
  ) |>
    sf::st_as_sf(
      coords = c("long", "lat"),
      crs = 4326
    )
}
```


```{r tests-map-utils}
test_that("read_cantons_sf works", {
  cantons_sf <- read_cantons_sf()
  
  expect_equal(
    colnames(cantons_sf),
    c(
      "GID_1",
      "GID_0",
      "COUNTRY",
      "NAME_1",
      "VARNAME_1",
      "NL_NAME_1",
      "TYPE_1",
      "ENGTYPE_1",
      "CC_1",
      "HASC_1",
      "ISO_1",
      "geometry"
    )
  )
  
  expect_equal(
    dim(cantons_sf),
    c(26L, 12L)
  )
  
  expect_s3_class(
    cantons_sf,
    c("sf", "data.frame")
  )
  
})

test_that("Switzerland centroid are coherent between computation and accessor function", {
  expect_equal(
    compute_switzerland_centroid(),
    get_switzerland_centroid()
  )
})

test_that("Switzerland bounding box are coherent between computation and accessor function", {
  expect_equal(
    compute_switzerland_bounding_box(),
    get_switzerland_bounding_box()
  )
})
```



# Draw leaflet map


```{r function-map}
#' Draw main interactive map
#'
#' @param projects_data_sf A sf data.frame containing coordinates of project 
#' main organisation and project `short_title`.
#' 
#' @return A leaflet object.
#' 
#' @importFrom stats setNames
#' @importFrom sf st_as_sf st_read st_bbox st_union st_centroid st_geometry
#' @importFrom leaflet leaflet setView addTiles addCircleMarkers addProviderTiles
#' @importFrom leaflet leafletOptions setMaxBounds addPolygons
#' 
#' @noRd
draw_leaflet_map <- function(
    projects_data_sf
) {
  
  cantons_sf <- read_cantons_sf()
  
  switzerland_centroid <- get_switzerland_centroid()
  switzerland_bounding_box <- get_switzerland_bounding_box()
  
  zoom_level <- 8
  leaflet(
    data = projects_data_sf,
    options = leafletOptions(minZoom = zoom_level)    
  ) |>
    addTiles() |>
    addPolygons( 
      data = cantons_sf,
      weight = 1,
      color = "#578397",
      fillColor = "#578397",
      fillOpacity = 0.3
    ) |> 
    addCircleMarkers(
      color = "#f59300",
      stroke = FALSE,
      fillOpacity = 0.8,
      label = ~ as.character(short_title)
    ) |>
    addProviderTiles(
      provider = "CartoDB.Positron"
      ) |>
    setView(
      lng = switzerland_centroid[["lng"]],
      lat = switzerland_centroid[["lat"]],
      zoom = zoom_level
    ) |> 
    setMaxBounds(
      lng1 = switzerland_bounding_box[["xmin"]],
      lat1 = switzerland_bounding_box[["ymin"]],
      lng2 = switzerland_bounding_box[["xmax"]],
      lat2 = switzerland_bounding_box[["ymax"]]
    )
}
```

```{r examples-map}
draw_leaflet_map(
  projects_data_sf = dummy_project_data_sf()
)
```

```{r tests-map}
test_that("draw_leaflet_map() returns a leaflet object", {
  expect_s3_class(
    draw_leaflet_map(
      projects_data_sf = dummy_project_data_sf()
    ),
    c("leaflet", "htmlwidget")
  )
})
```


```{r development-inflate, eval=FALSE}
# Run but keep eval=FALSE to avoid infinite loop
# Execute in the console directly
fusen::inflate(
  flat_file = "dev/flat_map.Rmd", 
  vignette_name = NA,
  check = FALSE,
  overwrite = TRUE
)
```

